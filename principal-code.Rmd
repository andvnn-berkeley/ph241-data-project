---
title: "PH241: Team Data Project"
author: "Andrew Nguyen, Jessica Pak, Joanne Yang"
date: "Spring 2022"
output:
  html_document:
    #code_folding: hide
    collapsed: true
    theme: flatly
    highlight: pygments
    toc: yes
    toc_depth: 3
    toc_float: yes
    keep_md: true
    number_sections: false
---

```{r libraries, include=F}
library(ggdag)
library(dagitty)
library(tidyverse)
library(lmtest)
library(generics)
library(broom)
library(caret)
library(MatchIt)
library(survival)
```

```{r import data, include=F}
diabetes <- read_csv("./datasets/diabetic_data.csv")
```

# Data Project: Readmission among Diabetes Patients

## Introduction

### The Data

The dataset in question contains deidentified patient visit data from over 130 United States hospitals and integrated delivery networks from 1999 - 2008. The data contains 100,000 observations from diabetes-related visits, each observation being one patient visit described through 50 attributes of patient demographics, outcomes, and hospital records regarding diagnostic and treatment information. Of particular interest is an attribute of patient readmission after the hospital visit, which this analysis is built upon. The dataset is publicly available and sourced from UC Irvine’s Machine Learning Repository <https://archive.ics.uci.edu/ml/datasets/Diabetes+130-US+hospitals+for+years+1999-2008>.

### The Research Question(s)

**Does class of diabetes medication impact the probability of hospital readmission for diabetes-related complications amongst patients with diabetes?** 

- Specifically, are there differences in odds of readmission across patients who are prescribed insulin compared to those who are prescribed metformin? 

**If patients are readmitted, which class(es) of diabetes medication is associated with more rapid readmission from the initial visit (<30 days vs. >30 days)?** 

- Does race influence either of these relationships of any readmission or quicker readmission?

### Research Rationale

Diabetes mellitus has been a worsening public health crisis in the United States, growing from 6.5 diagnosed adults to 20 million in 2010 (Gregg et al. 2014). The number of people in the United States with diabetes is projected to increase to approximately 50 million by 2050, which represents an unimaginable burden on the healthcare system in terms of pharmaceuticals and mitigative procedures, and loss to society in terms of quality of life and productivity lost (Rowley et al. 2017). Hospital readmission has been increasingly emphasized as an indicator of patient outcomes; rapid and continual readmissions put patients at risk for more complications, longer stays, higher costs, and worse outcomes (Ostling et al. 2017).

It is imperative then, to not only advocate for better preventive efforts, but also to understand which treatment and adaptation options are most effective, the primary option being medication to address metabolic syndromes that contribute to the many pathways leading to diabetes). 

Current treatment options for medications fall into the following types, or classes, of drugs that work in different ways to lower blood sugar (also known as blood sugar) levels: alpha-glucosidase inhibitors, biguanides, bile acid sequestrants, dopamine-2 agonists, DPP-4 inhibitors, meglitinides, SGLT2 Inhibitors, sulfonylureas, TZDs, and oral combination therapy, as well as hormone insulin (American Diabetes Association). These different classes differ in biological actions including inhibitory or stimulatory responses, target receptors, onset, peak time, and duration to mitigate blood sugar levels in the body. There are 24 generic diabetes medications recorded in our dataset that will be categorized according to their class prior to analysis. 

In our analysis, we are focused on the odds of readmission across two prevalent medication types: insulin (hormones) and metformin (biguanides). These two medications are commonly prescribed together and separately, with the former being widely understood as standard of care. However, the long-term effectiveness of insulin is not well-studied, and there is evidence of decreased quality of life and worse health outcomes, such as a higher rate of absorption for glucose, weight gain, and hypoglycemia (Erpeldinger et al., 2014). Clinical and animal model studies of metformin as a treatment for metabolic syndrome have seen promising results in terms of both efficacy and safety; increasing insulin sensitivity and reducing glucose production while having less side effects and risks for adverse health outcomes compared to comparable medication types like glucagon-like peptide-1 receptor agonists, Dipeptidyl peptidase-4 (DPP-4) inhibitors, and sulphonylurea, or insulin itself (Giannarelli et al., 2003; Scarpello, 2003; Ekström et al., 2012). Understanding if there are differences in the odds of readmission across those prescribed insulin and metformin will add evidence to the efficacy and safety profile of both in a field of pressing need for diabetes control.


Further, race in the United States’ society and healthcare system plays an outsized role in determining access and quality of care; therefore, understanding medication effectiveness and readmission is not complete without a secondary analysis on the impact of race/ethnicity when the data are available (Ohlson, 2020). 

### Population & Sample

Our target population is centered upon patients with diabetes in the United States. The data source is aggregated from a network of participating CERNER health centers that are not specifically disclosed, however, the geographic distribution is wide and could be assumed to be nationally representative: Midwest (18 hospitals), Northeast (58), South (28), and West (16). Given the geographic variety and large sample size, these data and ensuing analysis may be generalizable to the greater American population with diabetes. However, we remain mindful that this sample may be prone to forms of selection bias, where not all populations with diabetes may have access to care and therefore would not be recorded into electronic databases such as this one, maintained by CERNER Health Facts.

This dataset is appropriate for our analyses because of its aforementioned large sample size, general completeness of data, inclusion of many hospital-, treatment- , and patient-related characteristics, actions, and outcomes that make causal inference and regression analysis on diabetes-related visits possible. Patients with diabetes that were seen in this network of hospitals during 1999 to 2010 were sampled and deidentified from hospitals of varying sizes and geographies; visits had to be inpatient, have a diabetic encounter, a length of say from 1 to 14 days, laboratory tests conducted, and medications administered during the visit. No other information on the dataset sampling frame or inclusion criteria were provided (Strack et al. 2014). Further, we will exclude any observations in the dataset that are missing information on covariate data that cannot be imputed (i.e. categorical covariates).

## Data Cleaning

**Data Cleaning Objectives:**

- Create binary indicator variables for drug classes (any prescription of said drug = 1, else = 0)
- Create indicator variables for categorical variables (race, sex, type of admission source, etc.)
- Create age range indicator variables
- Create diagnosis indicator variables for groups of ICD-10 codes
- Factor all categorical variables

Create two datasets that are identical in predictor variables but with two distinct partitions of the response variable of readmission:

- Model 1: all readmission vs. no readmission
- Model 2: Readmission <30 days vs. readmission >30 days

```{r drug class indicator, warning=F, message=F, echo=F}
diabetes_clean <- diabetes

# Creating drug class indicator variables. There are 24 individual medications across different drug classes

#alpha-glucosidase inhibitor
diabetes_clean['acarbose'] = ifelse(diabetes['acarbose'] != 'No', 1, 0)
diabetes_clean['miglitol'] = ifelse(diabetes['miglitol'] != 'No', 1, 0)
#biguanide
diabetes_clean['metformin'] = ifelse(diabetes['metformin'] != 'No', 1, 0)
#hormone
diabetes_clean['insulin'] = ifelse(diabetes['insulin'] != 'No', 1, 0)
#diuretic
diabetes_clean['examide'] = ifelse(diabetes['examide'] != 'No', 1, 0)
#DPP-4 inhibitor
diabetes_clean['citoglipton'] = ifelse(diabetes['citoglipton'] != 'No', 1, 0) #sitagliptin??? citoglipton DNE
#meglitinide
diabetes_clean['repaglinide'] = ifelse(diabetes['repaglinide'] != 'No', 1, 0)
diabetes_clean['nateglinide'] = ifelse(diabetes['nateglinide'] != 'No', 1, 0)
#sulfonylureas
diabetes_clean['glimepiride'] = ifelse(diabetes['glimepiride'] != 'No', 1, 0)
diabetes_clean['glipizide'] = ifelse(diabetes['glipizide'] != 'No', 1, 0)
diabetes_clean['tolazamide'] = ifelse(diabetes['tolazamide'] != 'No', 1, 0)
diabetes_clean['tolbutamide'] = ifelse(diabetes['tolbutamide'] != 'No', 1, 0)
diabetes_clean['glyburide'] = ifelse(diabetes['glyburide'] != 'No', 1, 0)
diabetes_clean['chlorpropamide'] = ifelse(diabetes['chlorpropamide'] != 'No', 1, 0)
diabetes_clean['acetohexamide'] = ifelse(diabetes['acetohexamide'] != 'No', 1, 0)
#thiazolidinedione(glitazone)
diabetes_clean['pioglitazone'] = ifelse(diabetes['pioglitazone'] != 'No', 1, 0)
diabetes_clean['rosiglitazone'] = ifelse(diabetes['rosiglitazone'] != 'No', 1, 0)
diabetes_clean['troglitazone'] = ifelse(diabetes['troglitazone'] != 'No', 1, 0)
#combo
diabetes_clean['glyburide-metformin'] = ifelse(diabetes['glyburide-metformin'] != 'No', 1, 0)
diabetes_clean['glipizide-metformin'] = ifelse(diabetes['glipizide-metformin'] != 'No', 1, 0)
diabetes_clean['glimepiride-pioglitazone'] = ifelse(diabetes['glimepiride-pioglitazone'] != 'No', 1, 0)
diabetes_clean['metformin-rosiglitazone'] = ifelse(diabetes['metformin-rosiglitazone'] != 'No', 1, 0)
diabetes_clean['metformin-pioglitazone'] = ifelse(diabetes['metformin-pioglitazone'] != 'No', 1, 0)


```

```{r agg drug class, message=F, warning=F, echo=F}

# Aggregating medication into overarching drug classes (if there is at least one drug in the class prescribed, then the observation is true for that drug class). There are 6 drug classes in all.

# Drug Class
diabetes_clean2 <- diabetes_clean
diabetes_clean2['a_glucosidase.inhibitor'] = ifelse(diabetes_clean['acarbose'] == 1 | diabetes_clean['miglitol'] == 1, 1, 0)
diabetes_clean2['biguanide'] = ifelse(diabetes_clean['metformin'] == 1, 1, 0)
diabetes_clean2['hormone'] = ifelse(diabetes_clean['insulin'] == 1, 1, 0)
diabetes_clean2['diuretic'] = ifelse(diabetes_clean['examide'] == 1, 1, 0)
diabetes_clean2['ddp4.inhibitor'] = ifelse(diabetes_clean['citoglipton'] == 1, 1, 0)
diabetes_clean2['meglitinide'] = ifelse(diabetes_clean['repaglinide'] == 1 | diabetes['nateglinide'] == 1, 1, 0)
diabetes_clean2['sulfonylureas'] = ifelse(diabetes_clean['glimepiride'] == 1 | 
                                           diabetes_clean['glipizide'] == 1 | 
                                           diabetes_clean['tolazamide'] == 1| 
                                           diabetes_clean['tolbutamide'] == 1 | 
                                           diabetes_clean['glyburide'] == 1 |
                                           diabetes_clean['chlorpropamide'] == 1 |
                                           diabetes['acetohexamide'] == 1, 1, 0)
diabetes_clean2['glitazone'] = ifelse(diabetes_clean['pioglitazone'] == 1 | 
                                           diabetes_clean['rosiglitazone'] == 1 | 
                                           diabetes_clean['troglitazone'] == 1, 1, 0)
diabetes_clean2['combo'] = ifelse(diabetes_clean['glyburide-metformin'] == 1 | 
                                           diabetes_clean['glipizide-metformin'] == 1 | 
                                           diabetes_clean['glimepiride-pioglitazone'] == 1| 
                                           diabetes_clean['metformin-rosiglitazone'] == 1 | 
                                           diabetes_clean['metformin-pioglitazone'] == 1, 1, 0)
head(diabetes_clean2)

# Remove deprecated dataset for memory
rm(diabetes_clean)
rm(diabetes)
```
```{r}
# creating missing_race indicator variable
diabetes_clean2['missing_race'] <- ifelse(diabetes_clean2['race'] == '?', 1, 0) 
```


```{r non-drug cov, message=F, warning=F, echo=F}
# categorizing into numerical values

# 1 = home, 0 = otherwise
diabetes_clean2['dischargestatus'] <- ifelse(diabetes_clean2['discharge_disposition_id'] == 1, 0, 1)

# 1 = ER, 2 = Referral, 3 = Otherwise
diabetes_clean2['admissionsource'] <- ifelse(diabetes_clean2['admission_source_id'] == 7, 1, ifelse(diabetes_clean2['admission_source_id'] == 1, 2, 3))


diabetes_clean2$diag_1 <- as.numeric(diabetes_clean2$diag_1)

# 1 = circulatory, 2 = respiratory, 3 = digestive, 4 = diabetes, 5= injury, 6 = musculoskeletal, 7 = genitourinary, 8= neoplasms, 9 = other
diabetes_clean2['diagnosis'] <- ifelse(diabetes_clean2$diag_1 %in% c(390:459, 785), 1, 
                                      ifelse(diabetes_clean2$diag_1 %in% c(460:519, 786), 2,
                                             ifelse(diabetes_clean2$diag_1 %in% c(520:579, 787), 3, 
                                                    ifelse(between(diabetes_clean2$diag_1, 250, 250.999), 4,
                                                           ifelse(diabetes_clean2$diag_1 %in%c(800:999), 5, 
                                                                  ifelse(diabetes_clean2$diag_1 %in% c(710:739), 6,
                                                                         ifelse(diabetes_clean2$diag_1 %in% c(580:629, 788), 7,
                                                                                ifelse(diabetes_clean2$diag_1 %in% c(140:239, 780:782, 784, 790:799,240:249, 251:279, 680:709, 001:139, 290:319), 8, 9))))))))

# 1 = caucasian, 2 = african american, 3 = hispanic, 4 = other, 5 = missing
diabetes_clean2['race'] <- ifelse(diabetes_clean2['race'] == "Caucasian", 1,
                                  ifelse(diabetes_clean2['race'] == "AfricanAmerican", 2,
                                         ifelse(diabetes_clean2['race'] == "Hispanic", 3,
                                                ifelse(diabetes_clean2['race'] == "Other", 4, 5))))

# 1 = [0-10), 2= [10-20), 3= [20-30), 4 =[30-40), 5 = [40-50), 6= [50-60), 7 = [60-70), 8 =[70-80), 9= [80-90), 10 = [90-100) 
diabetes_clean2['age'] <- ifelse(diabetes_clean2['age'] == "[0-10)", 1,
                                 ifelse(diabetes_clean2['age'] == "[10-20)", 2,
                                        ifelse(diabetes_clean2['age'] == "[20-30)", 3,
                                               ifelse(diabetes_clean2['age'] == "[30-40)", 4,
                                                      ifelse(diabetes_clean2['age'] == "[40-50)", 5,
                                                             ifelse(diabetes_clean2['age'] == "[50-60)", 6,
                                                                    ifelse(diabetes_clean2['age'] == "[60-70)", 7,
                                                                           ifelse(diabetes_clean2['age'] == "[70-80)", 8,
                                                                                  ifelse(diabetes_clean2['age'] == "[80-90)", 9, 10)))))))))
                                                                                         

# 1 = male, 0 = female
diabetes_clean2['gender'] <- ifelse(diabetes_clean2['gender'] == "Male", 1, 0)

# medication type indicator variable (insulin = 0, metformin = 1)
diabetes_clean2 <- diabetes_clean2 %>%
  filter(insulin == 1 | metformin == 1) %>%
  mutate(medication = ifelse(insulin == 1, 0, 1))

```

```{r}
# cleaning readmission outcome

# outcome variable - binary: yes readmission or no readmission
diabetes_clean2['readmit_yesno'] = ifelse(diabetes_clean2['readmitted'] != 'NO', 1, 0)

# 2nd dataset with other 2nd outcome variable: only looking at 1. >30 or 0. <30 days
diabetes_clean3 <- diabetes_clean2 %>% 
  filter(readmitted != 'NO') %>% 
  mutate(readmit_30days = ifelse(readmitted == ">30", 0, 1))
head(diabetes_clean3)
```


```{r clean dataset, warning=F, message=F, echo=F}

# Diabetes clean data; num_medications is # distinct drugs administered, not specific to diabetic medications
diabetesfinal1 <- diabetes_clean2 %>% select(
  readmit_yesno, medication, race, diagnosis, time_in_hospital, num_medications, dischargestatus,
  admissionsource, age, gender)

diabetesfinal2 <- diabetes_clean3 %>% select(
  readmit_30days, medication, race, diagnosis, time_in_hospital, num_medications, dischargestatus,
  admissionsource, age, gender)

# Free up memory by removing datasets
rm(diabetes_clean2)
rm(diabetes_clean3)

# Factoring categorical variables.
diabetesfinal1$readmit_yesno = as.factor(diabetesfinal1$readmit_yesno)
diabetesfinal1$race = as.factor(diabetesfinal1$race)
diabetesfinal1$diagnosis = as.factor(diabetesfinal1$diagnosis)
diabetesfinal1$dischargestatus = as.factor(diabetesfinal1$dischargestatus)
diabetesfinal1$admissionsource = as.factor(diabetesfinal1$admissionsource)
diabetesfinal1$age = as.factor(diabetesfinal1$age)
diabetesfinal1$gender = as.factor(diabetesfinal1$gender)

diabetesfinal2$readmit_30days = as.factor(diabetesfinal2$readmit_30days)
diabetesfinal2$race = as.factor(diabetesfinal2$race)
diabetesfinal2$diagnosis = as.factor(diabetesfinal2$diagnosis)
diabetesfinal2$dischargestatus = as.factor(diabetesfinal2$dischargestatus)
diabetesfinal2$admissionsource = as.factor(diabetesfinal2$admissionsource)
diabetesfinal2$age = as.factor(diabetesfinal2$age)
diabetesfinal2$gender = as.factor(diabetesfinal2$gender)

str(diabetesfinal1)
head(diabetesfinal2)
```


## Exploratory Data Analysis (EDA)

With these data, we are interested in understanding if there are any differences in diabetes patient outcomes across diabetes medication, namely insulin compared to newer . The outcome afforded by the data collected are categorical readmission statuses (<30 days, >30 days, and no readmission). Since these outcomes are categorical, we look towards logistic regression to model an observation (patient's) probability to being readmitted based on type of medication and other personal and hospital characteristics.

Since there are three categories for the outcome variable, we plan on building two models from the same dataset:

- Model 1: Relationship between medication type and readmission at all (no readmission vs. all readmission)
- Model 2: Relationship between medication type and time until readmission (<30 days vs. >30 days)

### Data Missingness

```{r missingness, warning=F, message=F, echo=F}
#checking for missing observations for all variables dataset
sapply(diabetesfinal1, function(x) sum(is.na(x)))

#proportion of observations missing diagnosis value
sum(is.na(diabetesfinal1$diagnosis)) / nrow(diabetesfinal1) *100

```
After cleaning our data, we see that the primary diagnosis field sees some missing values (from the original dataset). This is problematic for later analysis, so we explore options to address the missingness (e.g. imputation or subsetting, among other options). Although it is a small proportion of the entire dataset (1.64%), we explore the covariate distribution of diagnosis missingness through comparative propensity scoring. In this, we utilize logistic regression to find the probability of missing given the covariates that we understand could affect receiving a diagnosis, elucidated by the DAG below. 

```{r dag diag, message=F, warning=F, echo=F}

# dag_diag <- dagitty('dag{
#                         rcv_diag [pos = "2, 1"]
#                         time [pos = "0, 1"]
#                         adm_src [pos = "0, 2"]
#                         race [pos = "0, 0"]
#                         
#                         time -> rcv_diag
#                         adm_src -> rcv_diag
#                         race -> rcv_diag
# }')
# 
# ggdag(dag_diag, layout = "circle")

```

```{r tx prop score 1, message=F, warning=F}
# diag_missing <- diabetesfinal1 %>% mutate(missing_diag = ifelse(is.na(diabetesfinal1$diagnosis) == T, 1, 0))
# 
# #propensity model with all terms directly or indirectly affecting treatment, not including interaction terms
# prop_tx <- glm(missing_diag ~  admissionsource + time_in_hospital + race, family = "binomial", data = diag_missing)
# #propensity model with all terms directly or indirectly affecting treatment, including interaction terms
# prop_tx_int <- glm(missing_diag ~  admissionsource*time_in_hospital*race, family = "binomial", data = diag_missing)
# 
# #model summaries
# tidy(prop_tx)
# tidy(prop_tx_int)
# 
# #likelihood ratio test between two models
# lrtest(prop_tx, prop_tx_int)
```

Since the propensity score model with the interaction terms is deemed to explain more of the data's variation to a significant degree via the likelihood ratio test, we build the propensity scores for missing diagnosis from that model over the parsimonious model without interaction terms.

Here, we build the propensity scores and visualize the distribution of propensity across groups of missing and non-missing diagnosis.
```{r tx prop score 2, message=F, warning=F}
#creating column named "prop" for propensities of receiving diagnosis
# diag_missing['prop'] <- predict(prop_tx, type="response", data=diag_missing)
# 
# #mutate new column in df for binary string categories of treatment
# ggplot(data = diag_missing %>% mutate(Diagnosis_Cat = ifelse(missing_diag == 1, "Undiagnosed (1)", "Diagnosed (0)")), 
#        aes(x = prop, 
#            #color code by treatment group
#            group=Diagnosis_Cat, 
#            fill = Diagnosis_Cat, 
#            color = Diagnosis_Cat)) +
#     geom_density(alpha = 0.25) + 
#     labs(x = "Propensity of receiving diagnosis based on covariates",
#          y = "Density",
#          fill = "Category of Diagnosis",
#          color = "Category of Diagnosis") +
#     theme_classic() +
#     theme(legend.position="top") +
#     scale_y_continuous(expand = c(0,0)) +
#     scale_x_continuous(expand = c(0,0))
```

From the density plot of propensity scores, we do see that a strong majority of observations that did receive diagnoses have similar covariate distribution such that it was strongly predicted that they would receive one (with propensity scores approaching 0). Among those who didn't receive a diagnosis, the covariate distribution was less concentrated in the very low propensity score region, which may be of slight concern. However, the gulf between densities across groups at propensity ~ 0 is likely due to the very small number of missng observations among a large dataset. We would be more concerned if there were no overlap between the two groups in terms of propensity for not receiving a diagnosis. Therefore, we feel comfortable with proceeding with the analysis after filtering out observations that did not receive a diagnosis. 

```{r missingness 2, message=F, warning=F, echo=F}
#filtering out missing observations 
diabetesfinal1 <- diabetesfinal1 %>% filter(is.na(diagnosis) == F)
diabetesfinal2 <- diabetesfinal2 %>% filter(is.na(diagnosis) == F)

#checking missingness across all columns
sapply(diabetesfinal1, function(x) sum(is.na(x))) 
```
## Analysis 

### Causal Framework: Directed Acyclic Graph of treatment/outcome relationship
```{r dag, message=F, warning=F, echo=F}

dag_diabetes <- dagitty('dag{
                        type [pos = "0, 1"]
                        ra [pos = "2, 1"]
                        mfx [pos = "1, 1"]
                        diag [pos = "1, 2"]
                        race [pos = "1, 1.5"]
                        age [pos = "0.75, 0.5"]
                        sex [pos = "1.25, 0.5"]
                        sev [pos = "1, 0"]
                        
                        type -> mfx
                        mfx -> ra
                        diag -> type
                        diag -> ra
                        race -> type
                        race -> ra
                        age -> mfx
                        age -> sev
                        sex -> mfx
                        sev -> type
                        sev -> ra
}')

ggdag(dag_diabetes, layout = "circle") + 
  theme_dag_blank()

```

### Positivity analysis

Before we fit our model, we want to examine whether the treated and non-treated groups are exchangeable, or that they both would have had comparable probabilities of being treated (i.e. being prescribed metformin). We do this by modeling the probability of receiving treatment as a function of the observed covariates that can be associated with treatment type. We want to include all predictors of the exposure and none of the effects of the exposure. Of course, this method will only allow us to examine treatment group balance among observed covariates (instead of all possible covariates.).

We decide to build propensity scores as a function of these covariates below, which may reflect treatment differences as a result of patient-provider social dynamics and severity of disease:

- race
- diagnosis
- time in hospital
- age

It may be argued that time in hospital could be related to the effect of the treatment rather than determining it. This is further expanded upon in the limitations section.

```{r positivity analysis, echo = F}


#propensity model with all terms directly or indirectly affecting treatment, not including interaction terms
pos_logit <- glm(medication ~ race + diagnosis + time_in_hospital + age, family = "binomial", data = diabetesfinal1)

pos_logit2 <- glm(medication ~ race + diagnosis + time_in_hospital + age, family = "binomial", data = diabetesfinal2)
#propensity model with all terms directly or indirectly affecting treatment, including interaction terms (won't run b/c it's probably too many terms)
#pos_logit_int <- glm(medication ~ race*diagnosis*time_in_hospital*num_medications*dischargestatus*admissionsource*age*gender, family = "binomial", data = diabetesfinal1)

#model summaries
tidy(pos_logit)
tidy(pos_logit2)
#tidy(pos_logit_int)

#likelihood ratio test between two models
#lrtest(pos_logit, pos_logit_int)


diabetesfinal1['prop'] <- predict(pos_logit, type="response", data=diabetesfinal1)
diabetesfinal2['prop'] <- predict(pos_logit2, type="response", data=diabetesfinal2)

#mutate new column in df for binary string categories of treatment
ggplot(data = diabetesfinal1 %>% mutate(Medication_Type = ifelse(medication == 1, "Metformin (1)", "Insulin (0)")), 
       aes(x = prop, 
           #color code by treatment group
           group=Medication_Type, 
           fill = Medication_Type, 
           color = Medication_Type)) +
    geom_density(alpha = 0.25) + 
    labs(x = "Propensity of receiving treatment based on covariates",
         y = "Density",
         fill = "Category of treatment",
         color = "Category of treatment",
         title = "Figure (x): Propensity of receiving treatment before exclusion") +
    theme_classic() +
    theme(legend.position="top") +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_continuous(expand = c(0,0)) +
  theme(plot.title = element_text(size=12, face="bold"))

ggplot(data = diabetesfinal2 %>% mutate(Medication_Type = ifelse(medication == 1, "Metformin (1)", "Insulin (0)")), 
       aes(x = prop, 
           #color code by treatment group
           group=Medication_Type, 
           fill = Medication_Type, 
           color = Medication_Type)) +
    geom_density(alpha = 0.25) + 
    labs(x = "Propensity of receiving treatment based on covariates",
         y = "Density",
         fill = "Category of treatment",
         color = "Category of treatment",
         title = "Figure (x): Propensity of receiving treatment before exclusion") +
    theme_classic() +
    theme(legend.position="top") +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_continuous(expand = c(0,0)) +
  theme(plot.title = element_text(size=12, face="bold"))
```

With the density plot of propensity scores above, we do see some violation of positivity, where those who were prescribed insulin (based on covariate distribution) would have had a very low propensity to being prescribed metformin, and vice versa. Thus, the populations in both tails of treatment propensity may not be exchangeable. We first subset the dataset to exclude observations in these tails (2.5% on each tail). 

We can address this my matching on propensity score with replacement, where observations across treatment groups are matched with a peer observation within 0.2 units of propensity. Matching is done with replacement as there is not an equal number of those prescribed the treatment versus not across the entire range of propensity; the final sample of 21160 observations has a balanced treatment distribution (55.4% having received the control medication insulin).


```{r matching, echo = F}
#exclude observations in each tail
diabetes_temp <- diabetesfinal1[diabetesfinal1$prop<quantile(diabetesfinal1$prop[diabetesfinal1$medication==1], probs=.975) & 
                     diabetesfinal1$prop>quantile(diabetesfinal1$prop[diabetesfinal1$medication==0], probs=.025),]

diabetes_temp2 <- diabetesfinal2[diabetesfinal2$prop<quantile(diabetesfinal2$prop[diabetesfinal2$medication==1], probs=.975) & 
                     diabetesfinal2$prop>quantile(diabetesfinal2$prop[diabetesfinal2$medication==0], probs=.025),]

#graph new propensity distribution
ggplot(data = diabetes_temp %>% mutate(Medication_Type = ifelse(medication == 1, "Metformin (1)", "Insulin (0)")), 
       aes(x = prop, 
           #color code by treatment group
           group=Medication_Type, 
           fill = Medication_Type, 
           color = Medication_Type)) +
    geom_density(alpha = 0.25) + 
    labs(x = "Propensity of receiving treatment based on covariates",
         y = "Density",
         fill = "Category of treatment",
         color = "Category of treatment",
         title = "Figure (x): Propensity of receiving treatment after exclusion") +
    theme_classic() +
    theme(legend.position="top") +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_continuous(expand = c(0,0)) +
  theme(plot.title = element_text(size=12, face="bold"))

ggplot(data = diabetes_temp2 %>% mutate(Medication_Type = ifelse(medication == 1, "Metformin (1)", "Insulin (0)")), 
       aes(x = prop, 
           #color code by treatment group
           group=Medication_Type, 
           fill = Medication_Type, 
           color = Medication_Type)) +
    geom_density(alpha = 0.25) + 
    labs(x = "Propensity of receiving treatment based on covariates",
         y = "Density",
         fill = "Category of treatment",
         color = "Category of treatment",
         title = "Figure (x): Propensity of receiving treatment after exclusion") +
    theme_classic() +
    theme(legend.position="top") +
    scale_y_continuous(expand = c(0,0)) +
    scale_x_continuous(expand = c(0,0)) +
  theme(plot.title = element_text(size=12, face="bold"))

#matching observations across treatment groups by propensity score, within 0.2 units of probability of one another, with replacement
matched_list <- matchit(formula = medication ~  prop, 
                        data = diabetes_temp, 
                        method = "nearest", 
                        replace=FALSE,
                        caliper=0.2, 
                        reestimate=FALSE,
                        ratio = 1)

matched_list2 <- matchit(formula = medication ~  prop, 
                        data = diabetes_temp2, 
                        method = "nearest", 
                        replace=FALSE,
                        caliper=0.2, 
                        reestimate=FALSE,
                        ratio = 1)

summary(matched_list, un = FALSE)
plot(matched_list, type = "jitter", interactive = FALSE)
diabetes_matched <- get_matches(matched_list)

summary(matched_list2, un = FALSE)
plot(matched_list2, type = "jitter", interactive = FALSE)
diabetes_matched2 <- get_matches(matched_list2)

```

After matching on propensity score, we fit our logistic regression models in alignment with our causal DAG. 

```{r analysis 1, echo = F}
#fit model 1 for readmission vs. no readmission
model1 <- clogit(as.numeric(readmit_yesno) ~ medication + race + 
                diagnosis + time_in_hospital + 
                num_medications + dischargestatus + 
                admissionsource + medication:race + strata(subclass),
              data = diabetes_matched, method = "exact")

summary(model1)

#fit model 2 for readmission <30 days vs. readmission >30 days
model2 <- clogit(as.numeric(readmit_30days) ~ medication + race + 
                diagnosis + time_in_hospital + 
                num_medications + dischargestatus + 
                admissionsource + medication:race + strata(subclass),
              data = diabetes_matched2, method = "exact")

summary(model2)
```

We also perform a sensitivity analysis with the dataset that excludes the tails of propensity scores but relies on weighting instead of matching on propensity scores. This may be an appropriate alternative approach given relative comparability in covariate distribution for a majority of the sample across the treatment groups.

```{r sensitivity, echo = F}
#create propensity weights; control weights = 1/1-prop; treatment weights = 1/prop
diabetesfinal1 <- diabetesfinal1 %>%
  mutate(weights = ifelse(medication == 0, 1/1-prop, 1/prop))

diabetesfinal2 <- diabetesfinal2 %>%
  mutate(weights = ifelse(medication == 0, 1/1-prop, 1/prop))

#fit model 1 for readmission vs. no readmission using propensity weights
model1_sens <- glm(readmit_yesno ~ medication + race + 
                diagnosis + time_in_hospital + 
                num_medications + dischargestatus + 
                admissionsource + medication:race, 
              family = "binomial", weights = weights,
              data = diabetesfinal1)

summary(model1_sens)

#fit model 2 for readmission <30 days vs. readmission >30 days using propensity weights
model2_sens <- glm(readmit_30days ~ medication + race + 
                diagnosis + time_in_hospital + 
                num_medications + dischargestatus + 
                admissionsource + medication:race, 
              family = "binomial", weights = weights,
              data = diabetesfinal2)

summary(model2_sens)

```

### Model Assumptions

Logistic regression does not require many of the assumptions and data conditions that linear regression requires, including a linear relationship between the independent and dependent variable, normal distribution of the residuals, constant variance of the dependent variable, and measurement of the dependent variable on an interval/ratio scale.

However, these assumptions about the data are made:

- Dependent variable is binary: this assumption is fulfilled by splitting the analysis into two models, described above.
- Linearity between the log odds of the outcome and each continuous predictor variables
- Observations are independent of one another: While it is possible that knowing that more than one patient(s) share the same family history, household, genetics, and/or neighborhood (among other observable characteristics) may influence one's perception on their outcomes based on prior patients, this dataset did not observe such characteristics and it is reasonably assumed that patient data are independent and uninfluenced of one another.
- Little or no multicollinearity among independent variables: this assumption was checked by looking at Variance Inflation Factor (VIF). 
- No extreme outliers: outliers were identified and removed using a Cook's Distance plot (shown); values that were 4 times over the mean Cook's Distance were excluded (in red).

**1. Outcome is a binary or dichotomous variable**
```{r assumption 1, echo = F}
# binary outcome variable
table(diabetesfinal1$readmit_yesno)
table(diabetesfinal2$readmit_30days)
```

note: had to delete diagnosis from model (missing values, need to deal with later) (should be fixed, see missingness section above)

**2. Linearity between the log odds of the outcome and each continuous predictor variables**
```{r}
# continuous variables: time_in_hospital, num_medications, (should we also consider age as "continuous" variable?)

# getting outcome probabilities: 
mod1 <- glm(readmit_yesno ~ medication+ race+time_in_hospital+ num_medications+ dischargestatus+ admissionsource+ age+ gender, data = diabetesfinal1, family = "binomial")
mod2 <- glm(readmit_30days ~ medication+ race+time_in_hospital+ num_medications+ dischargestatus+ admissionsource+ age+ gender, data = diabetesfinal2, family = "binomial")

prob1 <- predict(mod1, type = "response")
prob2 <- predict(mod2, type = "response")

# continuous predictor variables
cont_var1 <- diabetesfinal1 %>%
  select(time_in_hospital, num_medications) 

cont_var2 <- diabetesfinal2 %>%
  select(time_in_hospital, num_medications) 

pred1 <- colnames(cont_var1)
pred1 <- colnames(cont_var2)

# Bind the logit and tidying the data for plot
cont_var1 <- cont_var1 %>%
  mutate(logit = log(prob1/(1-prob1))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)

cont_var2 <- cont_var2 %>%
  mutate(logit = log(prob2/(1-prob2))) %>%
  gather(key = "predictors", value = "predictor.value", -logit)

# plotting linearity (might want to run tests of linearity instead ??)
ggplot(cont_var1, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  #geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")

ggplot(cont_var2, aes(logit, predictor.value))+
  geom_point(size = 0.5, alpha = 0.5) +
  #geom_smooth(method = "loess") + 
  theme_bw() + 
  facet_wrap(~predictors, scales = "free_y")

# lol the outcomes are hella wacky :o time in hospital might be a discrete varible but generally there's a linear relationship for num meds???
```

**3. No influential values (extreme values or outliers) in the continuous predictors**

we might need to explore another way to show this because the graphing way takes a really long time to run code

```{r assumption 3, echo =F}
# # broom package
# mod1.data <- augment(mod1) %>% 
#   mutate(index = 1:n()) 
# 
# mod2.data <- augment(mod2) %>% 
#   mutate(index = 1:n()) 
# 
# mod1.data$readmit_yesno <- as.factor(mod1.data$readmit_yesno)
# mod2.data$readmit_30days <-  as.factor(mod2.data$readmit_30days)
# # to check for outlier with standardized residual plot
# mod1.data %>% 
#   ggplot(aes(index, .std.resid)) + 
#   geom_point(aes(color = readmit_yesno), alpha = .5) +
#   scale_colour_manual(labels = c("Readmittance", "No Readmittance"),  values = c("red", "black")) +
#   theme_bw()
# 
# mod2.data %>% 
#   ggplot(aes(index, .std.resid)) + 
#   geom_point(aes(color = readmit_30days), alpha = .5) +
#   scale_colour_manual(labels = c("> 30 days", "<30 days"),  values = c("red", "black")) +
#   theme_bw()
# 
# # diagnostic test for influential points with cook's distance plot:
# cooks_crit = 0.5
# influence_cooks1 <- cooks.distance(mod1)
# df1 <- data.frame(obs = names(influence_cooks1),
#                  cooks = influence_cooks1)
# ggplot(df1, aes(y = cooks, x = obs)) +
#   geom_point() +
#   geom_hline(yintercept = cooks_crit, linetype="dashed") +
#   labs(title = "Cook's Distance",
#        subtitle = "Potential Influential Observations",
#        x = "Observation Number",
#        y = "Cook's")
# 
# influence_cooks2 <- cooks.distance(mod2)
# df2 <- data.frame(obs = names(influence_cooks2),
#                  cooks = influence_cooks2)
# ggplot(df2, aes(y = cooks, x = obs)) +
#   geom_point() +
#   geom_hline(yintercept = cooks_crit, linetype="dashed") +
#   labs(title = "Cook's Distance",
#        subtitle = "Potential Influential Observations",
#        x = "Observation Number",
#        y = "Cook's")
# 
# 
# # which points may be influential
# cont_var1[which(abs(influence_cooks1) > cooks_crit),]
# 
# cont_var2[which(abs(influence_cooks2) > cooks_crit),]
```

**4. No high intercorrelations (i.e. multicollinearity) among the predictors**
```{r assumption 4, echo =F}
car::vif(mod1)
car::vif(mod2)
```
To investigate multicollinearity among 
no mutlicollinearity:  VIF values below 5

## Results

Type of medication was strongly associated with the odds of readmission in 



## Conclusions

## Limitations